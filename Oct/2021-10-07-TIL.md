# ğŸ“‘Today I Learn (2021.10.07)

<br>

## **Django & Docker**

<br>

##  **ğŸ“Œ ì˜¤ëŠ˜ ë°°ìš°ê³  ì •ë¦¬í•œ ëª©ì°¨**
ï¼‘. Django ì™€ PostgreSQL ì—°ê²°

ï¼’. Docker Image Build & Docker Hub Upload

<br>

<br>

## ğŸ” ***Django ì™€ PostgreSQL ì—°ê²°***

<br>

#### ï¼‘. PostgreSQL ë‹¤ìš´

[PostgreSQL ë‹¤ìš´](https://www.enterprisedb.com/downloads/postgres-postgresql-downloads) â† ë“¤ì–´ê°€ì„œ ìµœì‹ .ver ë‹¤ìš´

---

<br>

#### ï¼’. SQL shell 

![image](https://user-images.githubusercontent.com/83274792/136396908-5ba0d0ac-fcf9-4ff9-95a9-9e68d7bf10e8.png)

ì‹¤í–‰ í›„ Enter 4ë²ˆ ì¹˜ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ë¼ê³  ë‚˜ì˜¤ëŠ”ë° 

ì²˜ìŒ ë‹¤ìš´ë¡œë“œ ë°›ì„ ë•Œ ì…ë ¥í•œ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥í–ˆë‹¤. 

ê·¸ë¦¬ê³  ë‚˜ì„œ ì•„ë˜ì™€ ê°™ì´ ê³„ì†í•´ì„œ ì§„í–‰í–ˆë‹¤. 
```shell
# DB ì´ë¦„ ì„¤ì •
postgres=ï¼ƒ CREATE DATABASE db_name;
# ì¶œë ¥ : CREATE DATABASE

# IDì™€ PW ì„¤ì •
postgres=ï¼ƒ CREATE USER user_id WITH PASSWORD '******';
# ì¶œë ¥ : CREATE ROLE

# encoding ì„¤ì •
postgres=ï¼ƒ ALTER ROLE user_id SET client_encoding TO 'utf8';
# ì¶œë ¥ : ALTER ROLE

# íŠ¸ëœì­ì…˜ ê³ ë¦½í™” ìˆ˜ì¤€ 1ë¡œ ì„¤ì •
postgres=ï¼ƒ ALTER ROLE user_id SET default_transaction_isolation TO 'read committed';
# ì¶œë ¥ : ALTER ROLE

# Timezone ì„¤ì •
postgres=ï¼ƒ ALTER ROLE user_id SET TIME ZONE 'Asia/Seoul';
# ì¶œë ¥ : ALTER ROLE

# GRANT ALL PRIVILEGES ON DATABASEëŠ” ë°ì´í„°ë² ì´ìŠ¤ì— ëŒ€í•œ CREATE,
# CONNECT ë° TEMPORARY ê¶Œí•œì„ userì— ë¶€ì—¬í•œë‹¤.
postgres=ï¼ƒ GRANT ALL PRIVILEGES ON DATABASE db_name To user_id;
# ì¶œë ¥ : GRANT
```
---

<br>

##### ï¼“. setting.pyì—ì„œ DATABASES ì„¤ì • ë³€ê²½
```python
DATABASES = { 
    'default': {
        'ENGINE': 'django.db.backends.postgresql', 
        'NAME': 'db_name',
        'USER': 'user_id',
        'PASSWORD' : '*******',
        'HOST' : 'localhost',
        'PORT' :'', } 
        }
```
---

<br>

##### ï¼”. pip install
ì²˜ìŒì— ê·¸ëƒ¥ `pip install psycog2`ë¥¼ ì„¤ì¹˜í–ˆì„ ë•, `makemigrations` ê³¼ì •ì—ì„œ

<span style="color:Red">***AssertionError: database connection isn't set to UTC***</span>

ìœ„ ì™€ ê°™ì€ ì—ëŸ¬ê°€ ë°œìƒí–ˆë‹¤. êµ¬ê¸€ë§ ê²°ê³¼ **psycopg2==2.8.6** ìœ¼ë¡œ ë‹¤ìš´ê·¸ë ˆì´ë“œ í–ˆë‹¤. 

ë‹¤ì‹œ `python manage.py makemigrations`ì™€ `python manage.py migrate`ë¥¼ ì°¨ë¡€ë¡œ 

ì‹¤í–‰í–ˆë”ë‹ˆ ì—ëŸ¬ ì—†ì´ ì„±ê³µí–ˆë‹¤.

---

<br>

##### 5. pgAdmin4
pgAdmin4ì— ë“¤ì–´ê°€ì„œ í™•ì¸ë§Œ í•˜ë©´ ëœë‹¤. mydjangoë¼ëŠ” DBìƒì„± í™•ì¸ â—â—â—

![image](https://user-images.githubusercontent.com/83274792/136403677-67b1125d-d073-4988-8399-46fec6fc3969.png)


ì´ì œ Tablesì— ë“¤ì–´ê°€ì„œ í…Œì´ë¸”ì´ ì œëŒ€ë¡œ ìƒì„±ëëŠ”ì§€ í™•ì¸í•˜ë©´ ë â—â—â—

![image](https://user-images.githubusercontent.com/83274792/136404655-bc58cb8c-33e0-4d2e-bfd6-724babaa1268.png)

---

<br>

<br>

## ğŸ” ***Docker Image Build***

<br>

#### 1. Django project ìƒì„±
```shell
$ python -m django startpoject project_name
```
---

<br>

#### 2. requirements.txt ìƒì„±
manage.pyì™€ ê°™ì€ ìœ„ì¹˜ì— ìƒì„±í•œë‹¤. 
```shell
# requirements.txt

django~=3.0.0
```
---

<br>

#### 3. Dockerfile ìƒì„±

```Dockerfile
FROM ubuntu:18.04

RUN apt-get update && \
    apt-get install -y python3-pip python3-dev && \
    apt-get clean

WORKDIR /code/
ADD ./backend /code
RUN pip3 install -r requirements.txt

EXPOSE 8000
CMD ["python3", "manage.py", "runserver", "0.0.0.0:8000"]
```
`apt-get update` : ì„¤ì¹˜ê°€ëŠ¥í•œ ë¦¬ìŠ¤íŠ¸ë¥¼ ì—…ë°ì´íŠ¸

`apt-get install` : ì„¤ì¹˜ê°€ëŠ¥í•œ ë¦¬ìŠ¤íŠ¸ ì„¤ì¹˜

`-y` : ì„¤ì¹˜ì‹œ ë‚˜íƒ€ë‚˜ëŠ” ëª¨ë“  ë¬¼ìŒì— yesë¥¼ ì‚¬ìš©í•˜ê² ë‹¤ëŠ” ì˜µì…˜ê°’

`apt-get clean` : ë””ë ‰í† ë¦¬ì— ë‹¤ìš´ë¡œë“œí•œ íŒŒì¼ì„ ì‚­ì œ

`WORKDIR /code/` : /code/ë¡œ ì‘ì—… ë””ë ‰í† ë¦¬ ì „í™˜

`ADD ./backend /code` : backendì˜ ëª¨ë“  íŒŒì¼ì„ codeíŒŒì¼ë¡œ ë³µì‚¬

---

<br>

#### 4. Build & DockerHub upload
```shell
docker build -t(or --tag) test_dj

# ì´ë¯¸ì§€ëª…:tagname ì—ì„œ tagname ì„¤ì • ì•ˆí•˜ë©´ defaultê°’(latest)
docker tag test_dj username/test_dj_2021:0.1

docker login
# ì¶œë ¥ : Login Succeeded

docker push username/test_dj_2021:0.1

# ë‹¤ë¥¸ cpuì—ì„œ ì ‘ì†ì‹œ (Docker ì„¤ì¹˜ í•„ìˆ˜)
# 8000í¬íŠ¸ëŠ” ë¹Œë“œ ì‹œ EXPOSEì— ì„ ì–¸.
docker run --rm --publish 9000:8000 gilbert9172/test_dj_2021:0.1
```
![image](https://user-images.githubusercontent.com/83274792/136416124-d5a64ea2-15b7-44e7-91ac-c910a7795867.png)

---

<br>

<br>

## ğŸ“ŒSummary
ì˜¤ëŠ˜ì€ flaskì—ì„œ ì‹¤íŒ¨í–ˆë˜ PostgreSQLì„ ì‚¬ìš©í•˜ì—¬ DBì™€ ì—°ê²°ì‹œí‚¤ëŠ”ë° ì„±ê³µí–ˆë‹¤.

ì²¨ì—ëŠ” Azureë„ ê°€ì…í•˜ê³  ì‚½ì§ˆ?ì„ ë§ì´ í–ˆì§€ë§Œ ê²°êµ­ í•´ê²°í•´ëƒˆë‹¤â—â—â—

ì •ë¦¬í•˜ê³  ìƒê°í•´ë³´ë‹ˆ ì—„ì²­ ì–´ë ¤ìš´ê±´ ì•„ë‹ˆì˜€ëŠ”ë° ë§ì´ ëŒì•„ì˜¨ê±° ê°™ë‹¤.

postgreì—°ê²° ë•ë¶„ì—? Docker ì´ë¯¸ì§€ ë¹Œë“œë„ ì•Œê²Œ ëê³ , DockerHubì— ì—…ë¡œë“œê¹Œì§€

í•˜ëŠ” ì¢‹ì€ ì‹œê°„ì„ ê°–ê²Œ ëë‹¤. postgre docsë¥¼ í‹ˆí‹ˆíˆ ì½ê³ , dockerë„ ì¢€ ë”

ê¹Šê²Œ ê³µë¶€í•´ì•¼ í•œë‹¤. (+ Azure ë¬´ë£Œì²´í—˜ì´ë‹ˆê¹ ë°°í¬ê¹Œì§€ í•´ì•¼í•œë‹¤.) 

---

<br>

<br>

## ğŸ’»References
- [PostgreSQL Docs](https://www.postgresql.org/docs/14/index.html)
- [Error í•´ê²°](https://exerror.com/assertionerror-database-connection-isnt-set-to-utc/)
- [Docker Docs](https://docs.docker.com/reference/)